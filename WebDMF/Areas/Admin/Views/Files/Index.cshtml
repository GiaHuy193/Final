@model IEnumerable<WebDocumentManagement_FileSharing.Models.Document>

@{
    ViewData["Title"] = "Quản trị tệp tin";
    var userEmails = ViewBag.UserEmails as IDictionary<string, string> ?? new Dictionary<string, string>();

    // Cấu hình quy tắc kiểm soát
    long WarningSizeLimit = 50 * 1024 * 1024; // Cảnh báo nếu file > 50MB
    string[] SafeExtensions = { ".jpg", ".jpeg", ".png", ".pdf", ".doc", ".docx", ".xls", ".xlsx", ".zip", ".rar" };
}

<style>
    /* Style cho Email bo tròn */
    .owner-badge {
        font-size: 0.85rem;
        color: #64748b;
        background: #f1f5f9;
        padding: 5px 15px;
        border-radius: 50px;
        border: 1px solid #e2e8f0;
        display: inline-flex;
        align-items: center;
        max-width: 220px;
    }

        .owner-badge i {
            font-size: 1rem;
            margin-right: 8px;
            color: #94a3b8;
        }

    /* Box Icon File */
    .file-icon-box {
        width: 42px;
        height: 42px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        font-size: 1.25rem;
    }

    /* Tên file gọn gàng */
    .file-name-text {
        max-width: 250px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: block;
        font-weight: 600;
    }

    .table-modern tr:hover {
        background-color: #f8fafc;
        transition: 0.2s;
    }
</style>

<div class="container-fluid px-4 py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-1">Hệ thống tệp tin</h2>
            <p class="text-muted small">Quản lý dung lượng và an ninh dữ liệu hệ thống</p>
        </div>

        <form asp-action="Index" method="get" class="d-flex gap-2">
            <div class="input-group" style="width: 320px;">
                <span class="input-group-text bg-white border-end-0 text-muted"><i class="bi bi-search"></i></span>
                <input type="text" name="search" class="form-control border-start-0 ps-0 shadow-none"
                       placeholder="Tìm tên hoặc email..." value="@ViewBag.CurrentSearch">
                <button type="submit" class="btn btn-primary px-4">Lọc</button>
            </div>
        </form>
    </div>

    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="table-responsive">
            <table class="table table-hover table-modern align-middle mb-0">
                <thead class="bg-light text-muted small uppercase">
                    <tr>
                        <th class="ps-4 py-3 border-0">TÊN TỆP TIN</th>
                        <th class="border-0">NGƯỜI SỞ HỮU</th>
                        <th class="border-0">DUNG LƯỢNG</th>
                        <th class="border-0">NGÀY TẢI LÊN</th> @* Cột Ngày tải đây Huy *@
                        <th class="border-0 text-center">TRẠNG THÁI</th>
                        <th class="text-end pe-4 border-0">THAO TÁC</th>
                    </tr>
                </thead>
                <tbody class="border-top-0">
                    @foreach (var item in Model)
                    {
                        var ext = System.IO.Path.GetExtension(item.FileName).ToLower();
                        bool isLarge = item.FileSize > WarningSizeLimit;
                        bool isUnsafe = !SafeExtensions.Contains(ext);

                        var iconClass = "bi-file-earmark-text text-primary bg-primary-subtle";
                        if (ext == ".jpg" || ext == ".png" || ext == ".jpeg") iconClass = "bi-file-earmark-image text-warning bg-warning-subtle";
                        else if (ext == ".pdf") iconClass = "bi-file-earmark-pdf text-danger bg-danger-subtle";
                        else if (ext == ".zip" || ext == ".rar") iconClass = "bi-file-earmark-zip text-info bg-info-subtle";

                        <tr class="@(isUnsafe ? "bg-danger bg-opacity-10" : "")">
                            <td class="ps-4">
                                <div class="d-flex align-items-center">
                                    <div class="file-icon-box @iconClass.Split(' ')[2] me-3">
                                        <i class="bi @iconClass.Split(' ')[0] @iconClass.Split(' ')[1]"></i>
                                    </div>
                                    <div>
                                        <span class="file-name-text @(isLarge ? "text-danger" : "")" title="@item.FileName">@item.FileName</span>
                                        <span class="text-muted" style="font-size: 0.7rem;">@item.ContentType.ToUpper()</span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="owner-badge">
                                    <i class="bi bi-person-circle"></i>
                                    <span class="text-truncate">
                                        @(userEmails.ContainsKey(item.OwnerId) ? userEmails[item.OwnerId] : item.OwnerId)
                                    </span>
                                </div>
                            </td>
                            <td class="fw-bold @(isLarge ? "text-danger" : "text-dark")">
                                @((item.FileSize / 1024.0 / 1024.0).ToString("0.##")) MB
                            </td>

                            @* HIỂN THỊ NGÀY TẢI LÊN *@
                            <td class="text-muted small">
                                <i class="bi bi-clock-history me-1"></i>
                                @item.UploadedDate.ToString("dd/MM/yyyy HH:mm")
                            </td>

                            <td class="text-center">
                                @if (isUnsafe)
                                {
                                    <span class="badge bg-danger rounded-pill">Nghi vấn</span>
                                }
                                else if (isLarge)
                                {

                                    <span class="badge bg-warning text-dark rounded-pill">Nặng</span>
                                }
                                else
                                {

                                    <span class="badge bg-success-subtle text-success rounded-pill">An toàn</span>
                                }
                            </td>
                            <td class="text-end pe-4">
                                <form asp-action="Delete" asp-route-id="@item.Id" method="post" onsubmit="return confirm('Xác nhận xóa vĩnh viễn tệp này?')">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-sm btn-outline-danger border-0 rounded-circle" style="width: 35px; height: 35px;">
                                        <i class="bi bi-trash3 fs-5"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>