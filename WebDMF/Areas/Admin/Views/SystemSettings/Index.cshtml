@model List<WebDocumentManagement_FileSharing.Models.SystemSetting>

@{
    ViewData["Title"] = "Cấu hình hệ thống";
}

<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />

<style>
    /* Card Style */
    .card-settings {
        border: 1px solid #dbdfe6;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        background-color: #fff;
    }

    /* Tabs */
    .nav-tabs-settings .nav-link {
        border: none;
        border-bottom: 3px solid transparent;
        color: #616f89;
        font-weight: 600;
        padding: 0.75rem 0;
        margin-right: 2rem;
    }

        .nav-tabs-settings .nav-link.active {
            color: #135bec;
            border-bottom-color: #135bec;
            background: transparent;
        }

    /* Forms */
    .form-label-bold {
        font-weight: 600;
        font-size: 0.875rem;
        color: #111318;
    }

    .quota-select {
        min-width: 200px;
    }

    /* Extension Tags Style */
    .ext-tag {
        display: inline-flex;
        align-items: center;
        background-color: #eef2ff;
        color: #4338ca;
        border: 1px solid #c7d2fe;
        border-radius: 6px;
        padding: 4px 10px;
        margin: 0 6px 6px 0;
        font-size: 0.85rem;
        font-weight: 500;
    }

        .ext-tag .remove-tag {
            margin-left: 6px;
            cursor: pointer;
            color: #6366f1;
            font-weight: bold;
            font-size: 1rem;
            line-height: 1;
        }

            .ext-tag .remove-tag:hover {
                color: #dc2626;
            }
</style>

<div class="container-fluid px-4 py-4">
    <header class="d-flex justify-content-between align-items-end mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1 small">
                    <li class="breadcrumb-item"><a href="#" class="text-decoration-none">Dashboard</a></li>
                    <li class="breadcrumb-item active">Cấu hình</li>
                </ol>
            </nav>
            <h1 class="fw-bold h2 mb-0">Cấu hình hệ thống</h1>
            <p class="text-muted small">Quản lý các cài đặt toàn cục và tham số vận hành ứng dụng DocNest</p>
        </div>
        <button type="submit" form="settingsForm" class="btn btn-primary d-flex align-items-center gap-2 px-4 fw-bold shadow-sm">
            <span class="material-symbols-outlined fs-5">save</span> Lưu thay đổi
        </button>
    </header>

    <ul class="nav nav-tabs nav-tabs-settings mb-4 border-bottom">
        <li class="nav-item"><a class="nav-link active" href="#">Cài đặt chung</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Bảo mật</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Thông báo</a></li>
    </ul>

    <form id="settingsForm" asp-area="Admin" asp-controller="SystemSettings" asp-action="SaveSettings" method="post">
        @Html.AntiForgeryToken()

        <div class="d-flex align-items-center gap-2 mb-3 mt-4">
            <span class="material-symbols-outlined text-primary">tune</span>
            <h5 class="mb-0 fw-bold">Thông tin ứng dụng</h5>
        </div>
        <div class="card card-settings p-4 mb-4">
            <div class="row g-4">
                <div class="col-md-6">
                    <label class="form-label form-label-bold">Tên ứng dụng</label>
                    <input type="text" class="form-control" name="appName" value="DocNest" />
                </div>
                <div class="col-md-6">
                    <label class="form-label form-label-bold">Email hỗ trợ</label>
                    <div class="input-group">
                        <span class="input-group-text bg-white"><span class="material-symbols-outlined fs-5">mail</span></span>
                        <input type="email" class="form-control" name="supportEmail" value="support@docnest.com" />
                    </div>
                </div>
                <div class="col-md-6">
                    <label class="form-label form-label-bold">Ngôn ngữ mặc định</label>
                    <select class="form-select">
                        <option selected value="vi">Tiếng Việt (Vietnamese)</option>
                        <option value="en">English (US)</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="d-flex align-items-center gap-2 mb-3">
            <span class="material-symbols-outlined text-primary">cloud_upload</span>
            <h5 class="mb-0 fw-bold">Quản lý tệp & Lưu trữ</h5>
        </div>

        <div class="card card-settings p-4 mb-4">
            @for (int i = 0; i < Model.Count; i++)
            {
                var key = Model[i].SettingKey ?? string.Empty;
                var desc = Model[i].Description ?? string.Empty;
                var val = Model[i].SettingValue ?? string.Empty;

                <input type="hidden" name="[@i].Id" value="@Model[i].Id" />
                <input type="hidden" name="[@i].SettingKey" value="@Model[i].SettingKey" />

                if (key == "StandardQuota" || key == "PremiumQuota")
                {
                    long bytes = 0;
                    long.TryParse(val, out bytes);
                    var mb = bytes / (1024 * 1024);
                    var displayLabel = key == "StandardQuota" ? "Quota Standard" : "Quota Premium";

                    <div class="d-flex justify-content-between align-items-center @(i < Model.Count - 1 ? "border-bottom mb-4 pb-4" : "")">
                        <div style="max-width: 70%;">
                            <div class="fw-bold mb-1">@displayLabel</div>
                            <div class="text-muted small">@desc</div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <select class="form-select quota-select" data-setting-index="@i">
                                <option value="1024">1 GB</option>
                                <option value="5120">5 GB</option>
                                <option value="15360">15 GB</option>
                                <option value="102400">100 GB</option>
                                <option value="custom">Tùy chỉnh...</option>
                            </select>
                            <input type="number" class="form-control custom-quota-input" data-setting-index="@i" placeholder="MB" min="1" style="width:120px; display:none;" />
                            <input type="hidden" id="setting-val-@i" name="[@i].SettingValue" value="@val" />
                        </div>
                    </div>
                }
                else if (key == "AllowedExtensions")
                {
                    <div class="d-flex justify-content-between align-items-start @(i < Model.Count - 1 ? "border-bottom mb-4 pb-4" : "")">
                        <div style="max-width: 40%;">
                            <div class="fw-bold mb-1">Định dạng cho phép</div>
                            <div class="text-muted small">@desc</div>
                        </div>
                        <div class="d-flex flex-column align-items-end flex-grow-1" style="max-width: 500px;">

                            <div id="ext-tags-container-@i" class="w-100 mb-3 p-2 bg-light border rounded" style="min-height: 40px;">
                            </div>

                            <div class="input-group">
                                <input type="text" class="form-control" id="ext-input-@i" placeholder="Nhập đuôi file (ví dụ: mp4)" />
                                <button type="button" class="btn btn-outline-primary" onclick="addExtension(@i)">
                                    <span class="material-symbols-outlined fs-6 align-middle">add</span> Thêm
                                </button>
                            </div>
                            <div class="form-text text-end">Nhập đuôi và nhấn Enter hoặc nút Thêm.</div>

                            <input type="hidden" id="setting-val-@i" name="[@i].SettingValue" value="@val" />
                        </div>
                    </div>
                }
                else
                {
                    <div class="d-flex justify-content-between align-items-center @(i < Model.Count - 1 ? "border-bottom mb-4 pb-4" : "")">
                        <div style="max-width: 70%;">
                            <div class="fw-bold mb-1">@Model[i].SettingKey</div>
                            <div class="text-muted small">@desc</div>
                        </div>
                        <div class="input-group w-auto">
                            <input type="text" name="[@i].SettingValue" class="form-control text-end fw-bold" value="@val" style="width: 240px;">
                        </div>
                    </div>
                }
            }
        </div>

        <div class="d-flex align-items-center gap-2 mb-3">
            <span class="material-symbols-outlined text-primary">build</span>
            <h5 class="mb-0 fw-bold">Bảo trì hệ thống</h5>
        </div>
        <div class="card card-settings p-4 mb-5">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <div class="fw-bold mb-1">Chế độ bảo trì</div>
                    <div class="text-muted small">Chỉ có Quản trị viên mới có thể truy cập khi bật.</div>
                </div>
                <div class="form-check form-switch fs-4">
                    <input class="form-check-input" type="checkbox" role="switch" id="maintenanceMode">
                </div>
            </div>
            <div class="border-top pt-4">
                <label class="form-label form-label-bold">Thông báo bảo trì</label>
                <textarea class="form-control" rows="3" placeholder="Thông báo cho người dùng..."></textarea>
            </div>
        </div>
    </form>
</div>

<script>
    // --- Global Helper Functions for Extensions ---

    // Lưu trữ danh sách extensions tạm thời cho từng setting index
    var extData = {};

    function renderTags(idx) {
        var container = document.getElementById('ext-tags-container-' + idx);
        var hiddenInput = document.getElementById('setting-val-' + idx);

        if (!container || !hiddenInput) return;

        // Xóa cũ
        container.innerHTML = '';

        // Render tags
        extData[idx].forEach(function(ext) {
            var tag = document.createElement('span');
            tag.className = 'ext-tag';
            tag.innerHTML = `${ext} <span class="remove-tag" onclick="removeExtension(${idx}, '${ext}')">&times;</span>`;
            container.appendChild(tag);
        });

        // Cập nhật giá trị vào hidden input (CSV)
        hiddenInput.value = extData[idx].join(',');
    }

    function addExtension(idx) {
        var input = document.getElementById('ext-input-' + idx);
        if (!input) return;

        var val = input.value.trim().toLowerCase();
        if (!val) return;

        // Tự thêm dấu chấm nếu thiếu
        if (!val.startsWith('.')) val = '.' + val;

        // Kiểm tra trùng
        if (!extData[idx].includes(val)) {
            extData[idx].push(val);
            renderTags(idx);
        }

        // Clear input
        input.value = '';
        input.focus();
    }

    function removeExtension(idx, ext) {
        extData[idx] = extData[idx].filter(e => e !== ext);
        renderTags(idx);
    }

    // --- Main Init ---
    document.addEventListener("DOMContentLoaded", function() {

        // 1. Init Extensions Data
        document.querySelectorAll('input[type="hidden"][id^="setting-val-"]').forEach(function(hidden) {
            var idx = hidden.id.replace('setting-val-', '');
            // Kiểm tra xem dòng này có phải là Extensions không (có container tags không)
            var container = document.getElementById('ext-tags-container-' + idx);
            if (container) {
                var initialVal = hidden.value || '';
                // Tách chuỗi CSV thành mảng
                extData[idx] = initialVal.split(',').map(s => s.trim().toLowerCase()).filter(s => s.length > 0);
                renderTags(idx);

                // Add event listener cho nút Enter trên ô input
                var input = document.getElementById('ext-input-' + idx);
                if(input){
                    input.addEventListener("keypress", function(event) {
                        if (event.key === "Enter") {
                            event.preventDefault(); // Chặn submit form
                            addExtension(idx);
                        }
                    });
                }
            }
        });

        // 2. Init Quota Logic (MB <-> Bytes)
        function mbToBytes(mb){ return (parseInt(mb) || 0) * 1024 * 1024; }

        document.querySelectorAll('.quota-select').forEach(function(sel){
            var idx = sel.getAttribute('data-setting-index');
            var hidden = document.getElementById('setting-val-' + idx);
            var customInput = document.querySelector('.custom-quota-input[data-setting-index="' + idx + '"]');

            if(!hidden) return; // Skip if extension row

            var currentBytes = parseInt(hidden.value || '0');
            var currentMB = Math.round(currentBytes / (1024*1024)) || 0;

            var matched = false;
            for(var i=0; i<sel.options.length; i++){
                if(sel.options[i].value !== 'custom' && parseInt(sel.options[i].value) === currentMB){
                    sel.selectedIndex = i; matched = true; break;
                }
            }
            if(!matched && customInput){
                sel.value = 'custom'; customInput.style.display=''; customInput.value = currentMB > 0 ? currentMB : '';
            }

            sel.addEventListener('change', function(){
                if(sel.value === 'custom'){
                    if(customInput) { customInput.style.display=''; customInput.focus(); }
                    if(hidden) hidden.value = mbToBytes(customInput.value || 0);
                } else {
                    if(customInput) customInput.style.display='none';
                    if(hidden) hidden.value = mbToBytes(sel.value);
                }
            });

            if(customInput){
                customInput.addEventListener('input', function(){
                    if(hidden) hidden.value = mbToBytes(this.value);
                });
            }
        });
    });
</script>