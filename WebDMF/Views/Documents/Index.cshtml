@using System.Linq
@using WebDocumentManagement_FileSharing.Helpers
@model WebDocumentManagement_FileSharing.Models.FileSystemViewModel

@{
    ViewData["Title"] = "Quản lý tệp tin";
    var currentReturnUrl = Url.Action("Index", "Documents", new { folderId = Model?.CurrentFolderId });
}

@functions {
    // HÀM: Lấy màu Gradient đồng bộ với trang Home
    public string GetFolderGradient(int id)
    {
        var gradients = new[]
        {
            "linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)",
            "linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)",
            "linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)",
            "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",
            "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)",
            "linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)",
            "linear-gradient(135deg, #fa709a 0%, #fee140 100%)",
            "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
            "linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%)",
            "linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%)"
        };
        return gradients[Math.Abs(id) % gradients.Length];
    }
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
    :root {
        --card-hover-shadow: 0 10px 20px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --text-primary: #1e293b;
        --text-secondary: #64748b;
    }

    /* --- UTILITIES --- */
    .cursor-pointer { cursor: pointer; }
    .dropdown-toggle::after { display: none !important; }

    /* --- FOLDER CARD (Style giống Home) --- */
    .folder-card {
        background-color: #fff;
        border: 1px solid rgba(0,0,0,0.05);
        border-radius: 16px;
        overflow: hidden;
        position: relative;
        transition: transform 0.2s, box-shadow 0.2s;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .folder-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--card-hover-shadow);
        border-color: rgba(0,0,0,0.1);
    }

    .folder-cover {
        height: 90px;
        width: 100%;
        position: relative;
    }
    
    .folder-cover::after {
        content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background: linear-gradient(120deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0.05) 40%, rgba(255,255,255,0) 100%);
        pointer-events: none;
    }

    .folder-body {
        padding: 12px 16px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        background: white;
    }

    .folder-name {
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: block;
        text-decoration: none;
    }

    .folder-meta {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-top: 2px;
    }

    /* --- NÚT 3 CHẤM (Glassmorphism) --- */
    .action-btn-glass {
        width: 32px; height: 32px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(4px);
        border: 1px solid rgba(255,255,255,0.5);
        color: #333;
        display: flex; align-items: center; justify-content: center;
        transition: all 0.2s;
    }
    .action-btn-glass:hover {
        background: #fff;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        color: var(--bs-primary);
    }

    /* --- FILE CARD (Grid View) --- */
    .file-card {
        border: 1px solid #f1f5f9;
        border-radius: 16px;
        overflow: hidden;
        transition: all 0.2s;
        height: 100%;
        background: white;
        position: relative;
    }
    .file-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--card-hover-shadow);
    }

    .file-preview-area {
        height: 130px;
        background-color: #f8fafc;
        display: flex; align-items: center; justify-content: center;
        position: relative;
    }
    .file-card-body { padding: 12px; }
    
    .file-name-link {
        font-weight: 500; font-size: 0.9rem; color: var(--text-primary);
        text-decoration: none; display: -webkit-box; -webkit-line-clamp: 2;
        -webkit-box-orient: vertical; overflow: hidden;
    }

    /* iframe styles for office previews */
    .office-preview-iframe {
        width: 100%;
        height: 100%;
        border: none;
        display: block;
    }

    /* helper to force images to cover */
    .object-fit-cover { object-fit: cover; width: 100%; height: 100%; display: block; }

    /* --- TABLE LIST VIEW --- */
    .custom-table { border-collapse: separate; border-spacing: 0; width: 100%; }
    .custom-table thead th {
        border-bottom: 1px solid #e2e8f0;
        color: var(--text-secondary);
        font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;
        padding: 1rem; font-weight: 600;
    }
    .custom-table tbody tr:hover { background-color: #f8fafc; }
    .custom-table td {
        border-bottom: 1px solid #f1f5f9;
        padding: 1rem; vertical-align: middle;
        color: var(--text-primary); font-size: 0.9rem;
    }

    /* --- VIEW TOGGLE BUTTONS --- */
    .view-toggle-btn {
        border: 1px solid #e2e8f0;
        color: var(--text-secondary);
        padding: 0.4rem 0.8rem;
        background: transparent;
    }
    .view-toggle-btn.active {
        background-color: #eff6ff; color: #3b82f6; border-color: #bfdbfe;
    }
</style>

<div class="container-fluid py-4 px-4">

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-5">
        <div>
            <h3 class="fw-bold mb-1" style="color: #0f172a;">Quản lý tệp tin</h3>
            <p class="text-muted small mb-0">Tổ chức và quản lý tài liệu của bạn</p>
        </div>

        <div class="d-flex align-items-center gap-2 mt-3 mt-md-0">
            <a class="btn btn-primary d-flex align-items-center shadow-sm" style="border-radius: 10px;" 
               asp-controller="Documents" asp-action="Create"
               asp-route-folderId="@(Model?.CurrentFolderId ?? 0)"
               asp-route-returnUrl="@currentReturnUrl">
                <i class="bi bi-cloud-arrow-up me-2"></i> Tải file lên
            </a>

            <form asp-controller="Folders" asp-action="UploadFolder" method="post" enctype="multipart/form-data" class="mb-0">
                @Html.AntiForgeryToken()
                <input type="hidden" name="folderId" value="@(Model?.CurrentFolderId == null ? 0 : Model.CurrentFolderId)" />
                <label class="btn btn-white border d-flex align-items-center shadow-sm" style="border-radius: 10px; cursor:pointer; background: white;">
                    <i class="bi bi-folder-plus me-2 text-secondary"></i> <span class="text-secondary">Tải thư mục</span>
                    <input type="file" name="files" webkitdirectory directory multiple style="display:none" onchange="this.form.submit()" />
                </label>
            </form>
        </div>
    </div>

    @if (TempData["Message"] != null) {
        <div class="alert alert-success border-0 shadow-sm rounded-3 mb-4 d-flex align-items-center"><i class="bi bi-check-circle-fill me-2"></i> @TempData["Message"]</div>
    }
    @if (TempData["Error"] != null) {
        <div class="alert alert-danger border-0 shadow-sm rounded-3 mb-4 d-flex align-items-center"><i class="bi bi-exclamation-circle-fill me-2"></i> @TempData["Error"]</div>
    }

    <div class="mb-5">
        <h6 class="fw-bold text-uppercase text-secondary small mb-3">Thư mục</h6>
        <div class="row g-3">
            @if (Model?.Folders != null && Model.Folders.Any())
            {
                foreach (var f in Model.Folders)
                {
                    <div class="col-6 col-md-4 col-lg-3 col-xl-2">
                        <div class="folder-card">
                            <div class="dropdown position-absolute" style="top: 10px; right: 10px; z-index: 20;">
                                <button class="action-btn-glass" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-boundary="viewport">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end border-0 shadow rounded-3">
                                    <li>
                                        <a class="dropdown-item" href="@Url.Action("Download", "Folders", new { id = f.Id })">
                                            <i class="bi bi-download me-2"></i> Tải xuống
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item rename-folder-trigger" href="#" data-id="@f.Id" data-name="@f.Name" data-bs-toggle="modal" data-bs-target="#renameModal">
                                            <i class="bi bi-pencil me-2"></i> Đổi tên
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item folder-star-toggle" href="#" data-id="@f.Id">
                                            <i class="bi bi-star me-2"></i> Gắn sao
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item share-trigger" href="#" data-id="@f.Id" data-title="@f.Name" data-type="folder">
                                            <i class="bi bi-share me-2"></i> Chia sẻ
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item text-danger folder-delete-btn" href="#" data-id="@f.Id">
                                            <i class="bi bi-trash me-2"></i> Xóa
                                        </a>
                                    </li>
                                </ul>
                            </div>

                            <a asp-action="Index" asp-route-folderId="@f.Id" class="text-decoration-none h-100">
                                <div class="folder-cover" style="background: @GetFolderGradient(f.Id);"></div>
                                <div class="folder-body">
                                    <span class="folder-name" title="@f.Name">@f.Name</span>
                                    <span class="folder-meta">@f.CreatedDate.ToString("dd/MM/yyyy")</span>
                                </div>
                            </a>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="col-12"><div class="p-4 text-center text-muted bg-light rounded-4 border border-dashed">Chưa có thư mục nào</div></div>
            }
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="fw-bold text-uppercase text-secondary small mb-0">Tệp tin</h6>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-sm view-toggle-btn rounded-start-pill active" id="listFilesBtn"><i class="bi bi-list-ul"></i></button>
            <button type="button" class="btn btn-sm view-toggle-btn rounded-end-pill" id="gridFilesBtn"><i class="bi bi-grid-fill"></i></button>
        </div>
    </div>

    <div id="filesGrid" class="row g-3 mb-4" style="display:none">
        @if (Model?.Documents != null && Model.Documents.Any())
        {
            foreach (var d in Model.Documents)
            {
                <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                    <div class="file-card">
                        <div class="dropdown position-absolute" style="top: 8px; right: 8px; z-index: 10;">
                            <button class="action-btn-glass" type="button" data-bs-toggle="dropdown" data-bs-boundary="viewport">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end shadow border-0 rounded-3">
                                <li>
                                    <a class="dropdown-item" asp-controller="Documents" asp-action="Download" asp-route-id="@d.Id">
                                        <i class="bi bi-download me-2"></i> Tải xuống
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item rename-doc-trigger" href="#" data-id="@d.Id" data-name="@d.FileName" data-bs-toggle="modal" data-bs-target="#renameModal">
                                        <i class="bi bi-pencil me-2"></i> Đổi tên
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item document-star-toggle" href="#" data-id="@d.Id">
                                        <i class="bi bi-star me-2"></i> Gắn sao
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item share-trigger" href="#" data-id="@d.Id" data-title="@d.FileName" data-type="document">
                                        <i class="bi bi-share me-2"></i> Chia sẻ
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item text-danger document-delete-btn" href="#" data-id="@d.Id" data-name="@d.FileName">
                                        <i class="bi bi-trash me-2"></i> Xóa
                                    </a>
                                </li>
                            </ul>
                        </div>

                        <a asp-controller="Documents" asp-action="Open" asp-route-id="@d.Id" target="_blank" class="text-decoration-none h-100">
                            <div class="file-preview-area">
                                @{
                                    var previewType = FilePreviewHelper.GetPreviewType(d.FileName, d.ContentType);
                                    if (previewType == FilePreviewType.Image) {
                                        <img src="@Url.Action("Open", "Documents", new { id = d.Id })" class="h-100 w-100 object-fit-cover" loading="lazy" />
                                    } else if (previewType == FilePreviewType.Office) {
                                        // embed preview page into an iframe for office documents
                                        <iframe class="office-preview-iframe" src="@Url.Action("Preview", "Documents", new { id = d.Id })" loading="lazy"></iframe>
                                    } else if (previewType == FilePreviewType.Pdf) {
                                        <i class="bi bi-file-earmark-pdf text-danger" style="font-size:3.5rem"></i>
                                    } else {
                                        var iconClass = d.FileName.EndsWith(".docx") ? "bi-file-earmark-word text-primary" : 
                                                        d.FileName.EndsWith(".xlsx") ? "bi-file-earmark-excel text-success" : "bi-file-earmark-text text-secondary";
                                        <i class="bi @iconClass" style="font-size: 3.5rem;"></i>
                                    }
                                }
                            </div>
                            <div class="file-card-body">
                                <div class="file-name-link" title="@d.FileName">@d.FileName</div>
                                <div class="d-flex justify-content-between mt-2 small text-muted">
                                    <span>@d.UploadedDate.ToString("dd/MM")</span>
                                    <span class="badge bg-light text-secondary border fw-normal">@(Math.Round(d.FileSize / 1024.0, 1)) KB</span>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12">
                <div class="p-4 text-center text-muted bg-light rounded-4">Không có tệp nào</div>
            </div>
        }
    </div>

    <div id="filesArea" class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="table-responsive">
            <table class="table custom-table mb-0">
                <thead class="bg-light">
                    <tr>
                        <th style="padding-left: 1.5rem">Tên tệp</th>
                        <th>Ngày tải</th>
                        <th>Kích thước</th>
                        <th class="text-end" style="padding-right: 1.5rem">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model?.Documents != null && Model.Documents.Any())
                    {
                        foreach (var d in Model.Documents)
                        {
                            <tr>
                                <td style="padding-left: 1.5rem">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-file-earmark-text-fill text-primary fs-4 me-3"></i>
                                        @{
                                            var previewType = FilePreviewHelper.GetPreviewType(d.FileName, d.ContentType);
                                            if (previewType == FilePreviewType.Image || previewType == FilePreviewType.Pdf || previewType == FilePreviewType.Office)
                                            {
                                                <a href="@Url.Action("Open", "Documents", new { id = d.Id })" target="_blank" class="fw-medium text-decoration-none text-dark">@d.FileName</a>
                                            }
                                            else
                                            {
                                                <span class="text-muted">@d.FileName</span>
                                                <span class="badge text-bg-secondary ms-2">Không hỗ trợ</span>
                                            }
                                        }
                                    </div>
                                </td>
                                <td class="text-muted">@d.UploadedDate.ToString("dd/MM/yyyy")</td>
                                <td class="text-secondary">@(Math.Round(d.FileSize / 1024.0, 1)) KB</td>
                                <td class="text-end" style="padding-right: 1.5rem">
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-light rounded-circle" data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
                                        <ul class="dropdown-menu dropdown-menu-end shadow border-0 rounded-3">
                                            <li>
                                                <a class="dropdown-item" asp-controller="Documents" asp-action="Download" asp-route-id="@d.Id"><i class="bi bi-download me-2"></i>Tải xuống</a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item rename-doc-trigger" href="#" data-id="@d.Id" data-name="@d.FileName" data-bs-toggle="modal" data-bs-target="#renameModal"><i class="bi bi-pencil me-2"></i>Đổi tên</a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item document-star-toggle" href="#" data-id="@d.Id"><i class="bi bi-star me-2"></i>Gắn sao</a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item share-trigger" href="#" data-id="@d.Id" data-title="@d.FileName" data-type="document"><i class="bi bi-share me-2"></i>Chia sẻ</a>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <a class="dropdown-item text-danger document-delete-btn" href="#" data-id="@d.Id" data-name="@d.FileName"><i class="bi bi-trash me-2"></i>Xóa</a>
                                            </li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr><td colspan="4" class="text-center py-5 text-muted">Thư mục trống</td></tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="renameModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow rounded-4">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Đổi tên</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="renameForm" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-body pt-3">
                    <input type="hidden" name="id" id="rename-id" />
                    <input type="hidden" id="rename-type" /> 
                    <input type="text" name="newName" id="rename-newName" class="form-control form-control-lg bg-light border-0" placeholder="Nhập tên mới..." required />
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-light rounded-3" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary rounded-3 px-4">Lưu</button>
                </div>
            </form>
        </div>
    </div>
</div>

<partial name="_ShareModal" />

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            'use strict';

            // 1. Rename Logic
            var renameForm = document.getElementById('renameForm');
            var renameType = document.getElementById('rename-type');

            document.querySelectorAll('.rename-folder-trigger').forEach(el => {
                el.addEventListener('click', function() {
                    document.getElementById('rename-id').value = this.getAttribute('data-id');
                    document.getElementById('rename-newName').value = this.getAttribute('data-name');
                    renameType.value = 'folder';
                    renameForm.action = '@Url.Action("Rename", "Folders")';
                });
            });

            document.querySelectorAll('.rename-doc-trigger').forEach(el => {
                el.addEventListener('click', function() {
                    document.getElementById('rename-id').value = this.getAttribute('data-id');
                    document.getElementById('rename-newName').value = this.getAttribute('data-name');
                    renameType.value = 'document';
                    renameForm.action = '@Url.Action("Rename", "Documents")';
                });
            });

            // 2. Delete Logic
            document.querySelectorAll('.document-delete-btn').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.preventDefault();
                    if (!confirm('Chuyển "' + this.getAttribute('data-name') + '" vào thùng rác?')) return;
                    fetch('@Url.Action("Delete", "Documents")', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value },
                        body: new URLSearchParams({ id: this.getAttribute('data-id'), confirmAction: 'trash' })
                    }).then(r => { if(r.ok) location.reload(); else alert('Lỗi xóa file'); });
                });
            });

            document.querySelectorAll('.folder-delete-btn').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.preventDefault();
                    if (!confirm('Xóa thư mục này?')) return;
                    fetch('@Url.Action("Delete", "Folders")', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value },
                        body: new URLSearchParams({ id: this.getAttribute('data-id') })
                    }).then(r => { if(r.ok) location.reload(); else alert('Lỗi xóa thư mục'); });
                });
            });

            // 3. View Mode Toggle
            const filesArea = document.getElementById('filesArea');
            const filesGrid = document.getElementById('filesGrid');
            const gridBtn = document.getElementById('gridFilesBtn');
            const listBtn = document.getElementById('listFilesBtn');

            function setMode(mode) {
                if (mode === 'grid') {
                    filesGrid.style.display = 'flex';
                    filesArea.style.display = 'none';
                    gridBtn.classList.add('active'); listBtn.classList.remove('active');
                } else {
                    filesGrid.style.display = 'none';
                    filesArea.style.display = 'block';
                    listBtn.classList.add('active'); gridBtn.classList.remove('active');
                }
                try { localStorage.setItem('files_view_mode', mode); } catch(e) {}
            }

            if (gridBtn && listBtn) {
                gridBtn.addEventListener('click', () => setMode('grid'));
                listBtn.addEventListener('click', () => setMode('list'));
                setMode(localStorage.getItem('files_view_mode') || 'list');
            }
        });
    </script>
}