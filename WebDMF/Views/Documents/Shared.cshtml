@model IEnumerable<WebDocumentManagement_FileSharing.Models.Permission>
@using Microsoft.AspNetCore.Identity
@inject UserManager<IdentityUser> UserManager

@{
    ViewData["Title"] = "Tài liệu được chia sẻ";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-primary">
            <i class="bi bi-share-fill me-2"></i> Tài liệu được chia sẻ với tôi
        </h3>
    </div>

    <div class="card shadow-sm border-0 rounded-3">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4" style="width: 40%;">Tên tài liệu</th>
                        <th style="width: 20%;">Người gửi</th>
                        <th style="width: 15%;">Ngày nhận</th>
                        <th style="width: 10%;">Quyền hạn</th>
                        <th class="text-end pe-4" style="width: 15%;">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        foreach (var item in Model)
                        {
                            <tr>
                                <td class="ps-4">
                                    <div class="d-flex align-items-center">
                                        @if (item.Document != null)
                                        {
                                            var ext = System.IO.Path.GetExtension(item.Document.FileName)?.ToLower();
                                            var iconClass = ext switch
                                            {
                                                ".pdf" => "bi-file-earmark-pdf-fill text-danger",
                                                ".docx" or ".doc" => "bi-file-earmark-word-fill text-primary",
                                                ".xlsx" or ".xls" => "bi-file-earmark-excel-fill text-success",
                                                ".png" or ".jpg" => "bi-file-earmark-image-fill text-info",
                                                _ => "bi-file-earmark-text-fill text-secondary"
                                            };

                                            <i class="bi @iconClass fs-4 me-2"></i>
                                            <a asp-action="Details" asp-route-id="@item.DocumentId" class="text-decoration-none fw-bold text-dark text-truncate" style="max-width: 250px;">
                                                @item.Document.FileName
                                            </a>
                                        }
                                        else if (item.Folder != null)
                                        {
                                            <i class="bi bi-folder-fill fs-4 text-warning me-2"></i>
                                            <a asp-controller="Documents" asp-action="Index" asp-route-folderId="@item.FolderId" class="text-decoration-none fw-bold text-dark text-truncate" style="max-width: 250px;">
                                                @item.Folder.Name
                                            </a>
                                        }
                                    </div>
                                </td>
                                <td>
                                    <span class="small">
                                        @{ 
                                            string ownerId = item.Document?.OwnerId ?? item.Folder?.OwnerId;
                                            var owner = string.IsNullOrEmpty(ownerId) ? null : await UserManager.FindByIdAsync(ownerId);
                                        }
                                        <i class="bi bi-person-circle me-1 text-muted"></i>
                                        @(owner?.UserName ?? "Người dùng hệ thống")
                                    </span>
                                </td>
                                <td class="small text-muted">
                                    @item.SharedDate.ToString("dd/MM/yyyy")
                                </td>
                                <td>
                                    @if (item.AccessType.ToString() == "Read")
                                    {
                                        <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle px-2">Chỉ xem</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success-subtle text-success border border-success-subtle px-2">Có thể sửa</span>
                                    }
                                </td>
                                <td class="text-end pe-4">
                                    <div class="btn-group shadow-sm">
                                        @if (item.Document != null)
                                        {
                                            <a asp-action="Download" asp-route-id="@item.DocumentId" class="btn btn-sm btn-white border" title="Tải xuống">
                                                <i class="bi bi-download"></i>
                                            </a>
                                            <a asp-action="Details" asp-route-id="@item.DocumentId" class="btn btn-sm btn-white border" title="Chi tiết">
                                                <i class="bi bi-info-circle"></i>
                                            </a>
                                        }
                                        else if (item.Folder != null)
                                        {
                                            <a asp-controller="Documents" asp-action="Index" asp-route-folderId="@item.FolderId" class="btn btn-sm btn-white border" title="Mở thư mục">
                                                <i class="bi bi-folder2-open"></i>
                                            </a>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="5" class="text-center py-5">
                                <div class="opacity-50">
                                    <i class="bi bi-cloud-slash fs-1 d-block mb-3"></i>
                                    <p class="mb-0">Danh sách chia sẻ trống.</p>
                                    <small>Khi người khác chia sẻ tài liệu cho bạn, chúng sẽ xuất hiện ở đây.</small>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    .table thead th {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 700;
        color: #6c757d;
        border-top: none;
    }

    .btn-white {
        background-color: #fff;
        color: #444;
    }

        .btn-white:hover {
            background-color: #f8f9fa;
            color: #000;
        }

    tr:hover {
        background-color: #fdfdfd !important;
    }
</style>