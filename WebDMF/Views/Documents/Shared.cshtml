@model WebDocumentManagement_FileSharing.Models.ViewModel.SharedListingsViewModel
@using Microsoft.AspNetCore.Identity
@using WebDocumentManagement_FileSharing.Models
@inject UserManager<ApplicationUser> UserManager

@{
    ViewData["Title"] = "Được chia sẻ với tôi";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
    /* --- CLEAN WHITE THEME --- */
    :root {
        --bg-body: #f8f9fa; /* Nền tổng thể xám rất nhạt */
        --bg-card: #ffffff; /* Nền card trắng tinh */
        --text-primary: #1e293b; /* Chữ đen xám đậm */
        --text-secondary: #64748b; /* Chữ xám vừa */
        --border-color: #e2e8f0; /* Viền xám nhạt */
        --primary-color: #3b82f6; /* Xanh dương chủ đạo */
    }

    body {
        background-color: var(--bg-body);
        color: var(--text-primary);
    }

    /* --- TABLE CARD --- */
    .shared-card {
        background-color: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); /* Bóng đổ rất nhẹ */
        overflow: hidden;
    }

    /* --- TABLE STYLING --- */
    .table-custom {
        margin-bottom: 0;
        border-collapse: separate;
        border-spacing: 0;
    }

        .table-custom thead th {
            background-color: #f1f5f9;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .table-custom tbody tr {
            transition: background-color 0.2s ease;
        }

            .table-custom tbody tr:hover {
                background-color: #f8fafc; /* Hover màu rất nhạt */
            }

        .table-custom td {
            padding: 1rem 1.5rem;
            vertical-align: middle;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .table-custom tbody tr:last-child td {
            border-bottom: none;
        }

    /* --- FILE ICON BOX --- */
    .file-icon-box {
        width: 42px;
        height: 42px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-right: 15px;
        background-color: #f8fafc; /* Nền icon xám nhạt */
        border: 1px solid #e2e8f0;
    }

    /* --- USER AVATAR --- */
    .user-avatar {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background-color: #e0e7ff; /* Nền tím nhạt mặc định */
        color: #4f46e5; /* Chữ tím đậm */
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.9rem;
        margin-right: 12px;
        border: 2px solid #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    /* --- BADGES (PASTEL STYLE) --- */
    .badge-soft {
        padding: 0.5em 0.8em;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.75rem;
    }

    .badge-soft-success {
        background-color: #dcfce7;
        color: #166534;
    }

    .badge-soft-info {
        background-color: #e0f2fe;
        color: #075985;
    }

    .badge-soft-secondary {
        background-color: #f1f5f9;
        color: #475569;
    }

    /* --- ACTIONS --- */
    .action-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 1px solid transparent;
        background: transparent;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

        .action-btn:hover {
            background-color: #f1f5f9;
            color: var(--primary-color);
            border-color: #e2e8f0;
        }

    /* Dropdown Styling */
    .dropdown-menu {
        border: 1px solid var(--border-color);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        border-radius: 12px;
        padding: 0.5rem;
    }

    .dropdown-item {
        border-radius: 8px;
        padding: 0.5rem 1rem;
        color: var(--text-primary);
        font-size: 0.9rem;
    }

        .dropdown-item:hover {
            background-color: #f1f5f9;
            color: var(--primary-color);
        }

    .dropdown-toggle::after {
        display: none !important;
    }
</style>

<div class="container-fluid py-5 px-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold mb-1" style="color: #1e293b;">Được chia sẻ với tôi</h3>
            <p class="text-secondary mb-0 small">Quản lý các tài liệu và thư mục mà người khác đã chia sẻ.</p>
        </div>
    </div>

    <div class="card shared-card mb-4">
        <div class="table-responsive">
            <table class="table table-custom mb-0">
                <thead>
                    <tr>
                        <th style="width: 35%;">Tên tài liệu</th>
                        <th style="width: 25%;">Người gửi</th>
                        <th style="width: 15%;">Ngày nhận</th>
                        <th style="width: 15%;">Quyền hạn</th>
                        <th class="text-end" style="width: 10%;">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model?.SharedWithMe != null && Model.SharedWithMe.Any())
                    {
                        foreach (var item in Model.SharedWithMe)
                        {
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        @if (item.Document != null)
                                        {
                                            var ext = System.IO.Path.GetExtension(item.Document.FileName)?.ToLower();
                                            var iconClass = ext switch
                                            {
                                                ".pdf" => "bi-file-earmark-pdf text-danger",
                                                ".docx" or ".doc" => "bi-file-earmark-word text-primary",
                                                ".xlsx" or ".xls" => "bi-file-earmark-excel text-success",
                                                ".png" or ".jpg" or ".jpeg" => "bi-file-earmark-image text-warning",
                                                _ => "bi-file-earmark-text text-secondary"
                                            };

                                            <div class="file-icon-box">
                                                <i class="bi @iconClass"></i>
                                            </div>
                                            <div>
                                                <a asp-controller="Documents" asp-action="Details" asp-route-id="@item.DocumentId" class="text-decoration-none fw-semibold text-dark d-block">
                                                    @item.Document.FileName
                                                </a>
                                                <span class="text-secondary small">@(Math.Round(item.Document.FileSize / 1024.0, 1)) KB</span>
                                            </div>
                                        }
                                        else if (item.Folder != null)
                                        {
                                            <div class="file-icon-box bg-warning-subtle text-warning" style="background-color: #fffbeb; border-color: #fcd34d;">
                                                <i class="bi bi-folder-fill"></i>
                                            </div>
                                            <div>
                                                <a asp-controller="Documents" asp-action="Index" asp-route-folderId="@item.FolderId" class="text-decoration-none fw-semibold text-dark d-block">
                                                    @item.Folder.Name
                                                </a>
                                                <span class="text-secondary small">Thư mục</span>
                                            </div>
                                        }
                                    </div>
                                </td>

                                <td>
                                    <div class="d-flex align-items-center">
                                        @{
                                            string ownerId = item.Document?.OwnerId ?? item.Folder?.OwnerId;
                                            var owner = string.IsNullOrEmpty(ownerId) ? null : await UserManager.FindByIdAsync(ownerId);
                                            var ownerName = owner?.UserName ?? "System";
                                            var firstLetter = !string.IsNullOrEmpty(ownerName) ? ownerName.Substring(0, 1).ToUpper() : "S";

                                            // Tạo màu ngẫu nhiên nhẹ nhàng cho avatar dựa trên ký tự đầu
                                            var colors = new[] { "#fee2e2", "#ffedd5", "#fef3c7", "#dcfce7", "#dbeafe", "#e0e7ff", "#fae8ff" };
                                            var textColors = new[] { "#991b1b", "#9a3412", "#92400e", "#166534", "#1e40af", "#3730a3", "#86198f" };
                                            var index = (int)firstLetter[0] % colors.Length;
                                            var bgColor = colors[index];
                                            var txtColor = textColors[index];
                                        }
                                        <div class="user-avatar" style="background-color: @bgColor; color: @txtColor;">
                                            @firstLetter
                                        </div>
                                        <div>
                                            <span class="d-block fw-medium text-dark" style="font-size: 0.9rem;">@ownerName</span>
                                            <span class="text-secondary small" style="font-size: 0.75rem;">@owner?.Email</span>
                                        </div>
                                    </div>
                                </td>

                                <td class="text-secondary">
                                    @item.SharedDate.ToString("dd/MM/yyyy")
                                </td>

                                <td>
                                    @if (item.AccessType == AccessLevel.Read)
                                    {
                                        <span class="badge badge-soft badge-soft-secondary">Chỉ xem</span>
                                    }
                                    else if (item.AccessType == AccessLevel.Download)
                                    {
                                        <span class="badge badge-soft badge-soft-info">Được tải</span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-soft badge-soft-success">Chỉnh sửa</span>
                                    }
                                </td>

                                <td class="text-end">
                                    <div class="dropdown">
                                        <button class="action-btn ms-auto" type="button" data-bs-toggle="dropdown">
                                            <i class="bi bi-three-dots"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            @if (item.Document != null)
                                            {
                                                @if (item.AccessType != AccessLevel.Read)
                                                {
                                                    <li>
                                                        <a asp-controller="Documents" asp-action="Download" asp-route-id="@item.DocumentId" class="dropdown-item">
                                                            <i class="bi bi-download me-2 text-primary"></i> Tải xuống
                                                        </a>
                                                    </li>
                                                }
                                                <li>
                                                    <a asp-controller="Documents" asp-action="Details" asp-route-id="@item.DocumentId" class="dropdown-item">
                                                        <i class="bi bi-info-circle me-2 text-secondary"></i> Chi tiết
                                                    </a>
                                                </li>
                                            }
                                            else if (item.Folder != null)
                                            {
                                                <li>
                                                    <a asp-controller="Documents" asp-action="Index" asp-route-folderId="@item.FolderId" class="dropdown-item">
                                                        <i class="bi bi-folder2-open me-2 text-warning"></i> Mở thư mục
                                                    </a>
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="5" class="text-center py-5">
                                <div class="d-flex flex-column align-items-center justify-content-center">
                                    <div class="bg-light rounded-circle p-4 mb-3" style="background-color: #f1f5f9;">
                                        <i class="bi bi-inbox fs-1 text-secondary opacity-50"></i>
                                    </div>
                                    <h6 class="text-dark fw-bold mb-1">Chưa có tài liệu nào</h6>
                                    <p class="text-secondary small">Danh sách này đang trống.</p>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <h4 class="fw-semibold mb-3">Các tài liệu tôi đã chia sẻ</h4>

    <div class="card shared-card">
        <div class="table-responsive">
            <table class="table table-custom mb-0">
                <thead>
                    <tr>
                        <th style="width: 35%;">Tên</th>
                        <th style="width: 25%;">Được chia sẻ cho</th>
                        <th style="width: 15%;">Ngày</th>
                        <th style="width: 15%;">Quyền</th>
                        <th class="text-end" style="width: 10%;">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model?.SharedByMe != null && Model.SharedByMe.Any())
                    {
                        foreach (var item in Model.SharedByMe)
                        {
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        @if (item.Document != null)
                                        {
                                            <div class="file-icon-box">
                                                <i class="bi bi-file-earmark-text text-secondary"></i>
                                            </div>
                                            <div>
                                                <a asp-controller="Documents" asp-action="Details" asp-route-id="@item.DocumentId" class="text-decoration-none fw-semibold text-dark d-block">
                                                    @item.Document.FileName
                                                </a>
                                                <span class="text-secondary small">@(Math.Round(item.Document.FileSize / 1024.0, 1)) KB</span>
                                            </div>
                                        }
                                        else if (item.Folder != null)
                                        {
                                            <div class="file-icon-box bg-warning-subtle text-warning" style="background-color: #fffbeb; border-color: #fcd34d;">
                                                <i class="bi bi-folder-fill"></i>
                                            </div>
                                            <div>
                                                <a asp-controller="Documents" asp-action="Index" asp-route-folderId="@item.FolderId" class="text-decoration-none fw-semibold text-dark d-block">
                                                    @item.Folder.Name
                                                </a>
                                                <span class="text-secondary small">Thư mục</span>
                                            </div>
                                        }
                                    </div>
                                </td>

                                <td>
                                    @{
                                        var receiver = await UserManager.FindByIdAsync(item.UserId);
                                        var receiverName = receiver?.UserName ?? "-";
                                        var first = !string.IsNullOrEmpty(receiverName) ? receiverName.Substring(0,1).ToUpper() : "-";
                                    }
                                    <div class="d-flex align-items-center">
                                        <div class="user-avatar" style="background-color: #e0f2fe; color: #075985;">@first</div>
                                        <div>
                                            <span class="d-block fw-medium text-dark" style="font-size: 0.9rem;">@receiverName</span>
                                            <span class="text-secondary small" style="font-size: 0.75rem;">@receiver?.Email</span>
                                        </div>
                                    </div>
                                </td>

                                <td class="text-secondary">@item.SharedDate.ToString("dd/MM/yyyy")</td>

                                <td>
                                    <form asp-controller="Share" asp-action="UpdatePermission" method="post" class="d-inline">
                                        <input type="hidden" name="id" value="@item.Id" />
                                        <select name="accessType" class="form-select form-select-sm" onchange="this.form.submit()" style="width: 140px; display:inline-block;">
                                            <option value="Read" selected="@(item.AccessType==AccessLevel.Read)">Chỉ xem</option>
                                            <option value="Download" selected="@(item.AccessType==AccessLevel.Download)">Được tải</option>
                                            <option value="Edit" selected="@(item.AccessType==AccessLevel.Edit)">Chỉnh sửa</option>
                                        </select>
                                    </form>
                                </td>

                                <td class="text-end">
                                    <form asp-controller="Share" asp-action="RevokePermission" method="post" onsubmit="return confirm('Bạn có chắc muốn thu hồi quyền chia sẻ này?');">
                                        <input type="hidden" name="id" value="@item.Id" />
                                        <button type="submit" class="btn btn-sm btn-outline-danger">Thu hồi</button>
                                    </form>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="5" class="text-center py-5">
                                <div class="d-flex flex-column align-items-center justify-content-center">
                                    <div class="bg-light rounded-circle p-4 mb-3" style="background-color: #f1f5f9;">
                                        <i class="bi bi-send fs-1 text-secondary opacity-50"></i>
                                    </div>
                                    <h6 class="text-dark fw-bold mb-1">Bạn chưa chia sẻ gì</h6>
                                    <p class="text-secondary small">Các tài liệu hoặc thư mục bạn chia sẻ sẽ xuất hiện ở đây.</p>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>