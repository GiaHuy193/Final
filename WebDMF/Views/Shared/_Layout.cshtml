@using System.Linq
@using System.IO
@using Microsoft.AspNetCore.Identity
@using WebDocumentManagement_FileSharing.Helpers
@using WebDocumentManagement_FileSharing.Models
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject WebDocumentManagement_FileSharing.Data.ApplicationDbContext DbContext

@{
    // Logic Razor Page giữ nguyên
    var pageValue = ViewContext?.RouteData?.Values?["page"];
    var currentPage = (pageValue as string) ?? pageValue?.ToString() ?? string.Empty;

    // Kiểm tra area nếu có
    var areaValue = ViewContext?.RouteData?.Values?["area"] as string ?? string.Empty;

    // Kiểm tra trạng thái xác thực người dùng
    var isAuthenticated = SignInManager.IsSignedIn(User); // Sử dụng SignInManager để kiểm tra chính xác hơn

    // Xác định trang xác thực: Bất kỳ trang nào trong khu vực Identity (Login/Register/...)
    var hideSidebar = !string.IsNullOrEmpty(areaValue) && string.Equals(areaValue, "Identity", StringComparison.OrdinalIgnoreCase)
    || (!string.IsNullOrEmpty(currentPage) && currentPage.StartsWith("/Identity/Account", StringComparison.OrdinalIgnoreCase));

    // Cho phép ghi đè hiển thị sidebar từ ViewData (ví dụ: ở Index.cshtml đặt ViewData["ForceShowSidebar"] = true)
    var forceShowSidebar = (ViewData["ForceShowSidebar"] as bool?) == true;

    // Tính toán hiển thị sidebar: hiển thị khi không phải trang Identity và (đã đăng nhập hoặc được ghi đè)
    var showSidebar = !hideSidebar && (isAuthenticated || forceShowSidebar);

    // Thiết lập lớp CSS cho thẻ <main>
    var mainContentClass = showSidebar ? "content-area" : "content-area content-full-width";

    // XÁC ĐỊNH URL CHO LOGO KHI CHƯA ĐĂNG NHẬP
    // Nếu CHƯA đăng nhập: Logo trỏ về gốc tuyệt đối (href="/") để thoát khỏi khu vực Identity/Register.
    var logoRedirectUrl = isAuthenticated ? Url.Action("Index", "Home") : "/";

    // Determine folderId from query string for upload-folder forms (layout-level)
    int layoutFolderId = 0;
    int.TryParse(Context.Request.Query["folderId"], out layoutFolderId);

    // Quota widget data
    long usedOnDisk = 0;
    // Default quotas
    long standardQuota = 15L * 1024 * 1024 * 1024; // 15 GB
    long premiumQuota = 100L * 1024 * 1024 * 1024; // 100 GB

    try
    {
        // Read StandardQuota from SystemSettings
        var s = DbContext?.SystemSettings?.FirstOrDefault(ss => ss.SettingKey == "StandardQuota");
        if (s != null && long.TryParse(s.SettingValue, out var q))
        {
            standardQuota = q;
        }
    }
    catch { /* ignore DB read errors and fall back to default */ }

    try
    {
        // Read PremiumQuota from SystemSettings
        var p = DbContext?.SystemSettings?.FirstOrDefault(ss => ss.SettingKey == "PremiumQuota");
        if (p != null && long.TryParse(p.SettingValue, out var qp))
        {
            premiumQuota = qp;
        }
    }
    catch { }

    // Default to standard
    long quota = standardQuota;
    string tierLabel = "Standard";

    if (isAuthenticated)
    {
        var u = UserManager.GetUserAsync(User).GetAwaiter().GetResult();
        if (u != null)
        {
            // if user is premium, use premium quota
            var userIsPremium = u.IsPremium;
            if (userIsPremium)
            {
                quota = premiumQuota;
                tierLabel = "Premium";
            }
            else
            {
                quota = standardQuota;
                tierLabel = "Standard";
            }

            var email = !string.IsNullOrEmpty(u.Email) ? u.Email : u.UserName ?? u.Id;
            var invalid = System.IO.Path.GetInvalidFileNameChars();
            var cleaned = new string(email.Select(c => invalid.Contains(c) ? '_' : c).ToArray());
            cleaned = cleaned.Replace('@', '_').Replace(' ', '_').Trim();
            if (string.IsNullOrEmpty(cleaned)) { cleaned = "unknown"; }
            var uploadsRoot = System.IO.Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "uploads");
            var userFolder = System.IO.Path.Combine(uploadsRoot, cleaned);
            if (System.IO.Directory.Exists(userFolder))
            {
                try
                {
                    var dir = new System.IO.DirectoryInfo(userFolder);
                    usedOnDisk = dir.GetFiles("*", System.IO.SearchOption.AllDirectories).Sum(f => f.Length);
                }
                catch { usedOnDisk = 0; }
            }
        }
    }

    double pct = quota > 0 ? (usedOnDisk * 100.0 / quota) : 0;
    string barClass = pct < 70 ? "bg-success" : pct < 90 ? "bg-warning" : "bg-danger";
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@((ViewData["Title"] as string) ?? "") - DocNest Document Management</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/WebDocumentManagement_FileSharing.styles.css" asp-append-version="true" />

    <style>
        /* ---------------------------------------------------------------------- */
        /* BIẾN CSS (CSS Variables) - Cho phép chuyển đổi dễ dàng */
        /* ---------------------------------------------------------------------- */
        :root {
            /* offset to align header logo with sidebar content */
            --sidebar-offset: 2.5rem; /* matches Bootstrap px-3 (16px) */

            /* Màu chủ đạo/Nhấn */
            --primary-color: #1DA1F2;
            --primary-hover-color: #188DD9;
            /* Light Mode */
            --bg-body: #F7F9F9; /* Nền chính */
            --bg-header: #FFFFFF;
            --bg-sidebar: #FFFFFF;
            --bg-hover: #F0F4F7;
            --bg-active: #EAF5FD;
            --text-color: #14171A; /* Chữ tối */
            --text-secondary: #5B7083; /* Chữ xám */
            --border-color: #E1E8ED;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --input-bg: #FFFFFF;
            --input-border: #CCD6DD;
            /* Sidebar text color: black in light mode */
            --sidebar-text-color: #14171A;
        }

        /* DARK MODE (Midnight Blue - Giống Twitter) */
        body.dark-mode {
            --primary-color: #1DA1F2;
            --primary-hover-color: #49A9EC;
            --bg-body: #15202B; /* Nền Midnight Blue chính */
            --bg-header: #15202B;
            --bg-sidebar: #15202B;
            --bg-hover: #1C2B3A;
            --bg-active: #1D415F;
            --text-color: #F7F9F9;
            --text-secondary: #8899A6;
            --border-color: #38444D;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --input-bg: #22303C;
            --input-border: #38444D;
            /* Sidebar text color: white in dark mode */
            --sidebar-text-color: #FFFFFF;
        }

        /* ---------------------------------------------------------------------- */
        /* ÁP DỤNG BIẾN */
        /* ---------------------------------------------------------------------- */

        /* Màu nền chính và chữ mặc định */
        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-body);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        /* HEADER */
        .app-header {
            background-color: var(--bg-header);
            height: 64px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            box-shadow: 0 2px 6px var(--shadow-color);
            z-index: 1030;
        }

        .brand {
            color: var(--primary-color);
            font-weight: 700;
            font-size: 1.25rem;
            text-decoration: none;
            padding-left: var(--sidebar-offset); /* align with sidebar content */
        }

        /* sidebar layout to push quota to bottom */
        .sidebar {
            width: 250px;
            background: var(--bg-sidebar);
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
            flex-shrink: 0;
            padding-top: 18px;
            border-right: 1px solid var(--border-color);
            /* ensure vertical layout so quota can sit at bottom */
            display: flex !important;
            flex-direction: column !important;
            height: calc(100vh - 64px) !important; /* full height under header */
        }

        /* Ensure sidebar brand uses same offset so logo aligns with items */
        .sidebar-brand { padding-left: var(--sidebar-offset); }

        /* Apply sidebar text color variable so links/text contrast with sidebar background */
        .sidebar, .offcanvas {
            color: var(--sidebar-text-color);
        }

        .sidebar .nav-link, .offcanvas .nav-link {
            color: var(--sidebar-text-color) !important;
        }

        .sidebar .nav-link.active, .offcanvas .nav-link.active {
            color: var(--primary-color) !important;
        }

        .sidebar .nav {
            flex: 1 1 auto;
            overflow: auto;
            padding-bottom: 1rem;
        }

        /* Sidebar nav icons: white with black outline */
        .sidebar .nav-link i {
            color: #ffffff !important;
            /* create a thin black border/outline around the icon using text-shadow */
            text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
            vertical-align: -0.125em;
        }

        /* quota widget inside sidebar */
        .quota-widget {
            width: calc(100% - 24px);
            margin: 12px;
            border-radius: 8px;
            padding: 10px;
            background: rgba(255,255,255,0.95);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
            align-self: center;
        }

        .quota-widget .small { font-size: 0.8rem; }

        /* ensure offcanvas body can place quota at bottom */
        .offcanvas-body {
            display: flex;
            flex-direction: column;
            padding-bottom: 1rem;
        }

        .offcanvas-body .nav {
            flex: 1 1 auto;
            overflow: auto;
        }

        /* Push quota widget to bottom inside offcanvas */
        .offcanvas-body .quota-widget { margin-top: auto; }

        /* NÚT (BUTTONS) */
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: #fff;
        }

            .btn-primary:hover {
                background-color: var(--primary-hover-color);
                border-color: var(--primary-hover-color);
                color: #fff;
            }

        .btn-outline-secondary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

            .btn-outline-secondary:hover {
                background-color: var(--primary-color);
                color: #fff;
            }

        /* New: Gradient style for the "+ Tạo mới" buttons to match provided design */
        .btn-create {
            background-image: linear-gradient(90deg, #0f1330 0%, #2b0f4a 20%, #6b3bd6 60%, #9b6cf6 100%);
            color: #fff !important;
            border: none !important;
            box-shadow: 0 8px 30px rgba(107, 59, 214, 0.18), inset -8px 0 20px rgba(0,0,0,0.35);
            padding: 0.625rem 1rem;
            font-weight: 700;
            transition: transform 0.12s ease, box-shadow 0.12s ease;
        }

        .btn-create:hover, .btn-create:focus {
            transform: translateY(-1px);
            box-shadow: 0 12px 36px rgba(107, 59, 214, 0.22), inset -6px 0 16px rgba(0,0,0,0.30);
            color: #fff !important;
        }

        .btn-create:active {
            transform: translateY(0);
            box-shadow: 0 6px 20px rgba(107, 59, 214, 0.15), inset -4px 0 10px rgba(0,0,0,0.28);
        }

        /* MAIN LAYOUT */
        .main-wrapper {
            display: flex;
            min-height: calc(100vh - 64px);
        }

        /* CONTENT AREA */
        .content-area {
            flex-grow: 1;
            padding: 24px;
            overflow-y: auto;
            color: var(--text-color);
        }

            .content-area.content-full-width {
                flex-grow: 1;
                width: 100%;
                padding-left: 24px !important;
                padding-right: 24px !important;
            }

        /* CÁC THÀNH PHẦN KHÁC (FORMS, DROPDOWNS, CARDS, TABLES) */
        .form-control {
            background-color: var(--input-bg);
            border-color: var(--input-border);
            color: var(--text-color);
        }

            .form-control::placeholder {
                color: var(--text-secondary);
                opacity: 1;
            }

        /* Dropdown Menu (Chung cho Profile/Tải lên) */
        .dropdown-menu {
            background-color: var(--bg-header);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .dropdown-item {
            color: var(--text-color);
        }

            .dropdown-item:hover {
                background-color: var(--bg-hover);
                color: var(--primary-color);
            }

        /* FIX: Card và Table (Thay thế nền tối) */
        .card,
        .table,
        .table-responsive {
            background-color: var(--bg-header) !important;
            border-color: var(--border-color);
            color: var(--text-color);
        }

        .card-body,
        .card-text {
            color: var(--text-color);
        }

        .table th,
        .table td {
            border-color: var(--border-color);
            color: var(--text-color);
        }

        /* ====================================================================== */
        /* FIX THANH TIÊU ĐỀ BẢNG (Tên / Ngày tải / Kích thước / Thao tác) */
        /* ====================================================================== */

        /* XÓA NỀN TRẮNG MẶC ĐỊNH CỦA BOOTSTRAP */
        .table > :not(caption) > * > * {
            background-color: transparent !important;
        }

        /* HEADER BẢNG */
        .table thead {
            background-color: var(--bg-hover) !important;
        }

            .table thead th {
                background-color: var(--bg-hover) !important;
                color: var(--text-color) !important;
                font-weight: 600;
                border-bottom: 1px solid var(--border-color) !important;
                vertical-align: middle;
            }

        /* HOVER DÒNG */
        .table tbody tr:hover {
            background-color: var(--bg-hover);
        }


        /* ====================================================================== */
        /* >>> FIX: Màu Icon, Tiêu đề Folder & Dropdown Profile <<< */

        /* FIX 1: Đảm bảo tiêu đề folder và văn bản trong card là màu TỐI */
        .card *,
        .card a {
            color: var(--text-color) !important;
        }

        /* FIX 2: Khôi phục màu vàng cam cho class text-warning (dùng cho icon folder) */
        .text-warning,
        .bi-folder-plus.text-warning,
        .card .text-warning {
            color: #FFC107 !important; /* MÀU VÀNG CAM CỦA FOLDER */
        }

        /* Ngoại lệ: Văn bản mờ nếu bạn có text-muted */
        .card .text-muted {
            color: var(--text-secondary) !important; /* Xám mờ */
        }

        /* FIX 3: Loại bỏ nền trắng xung quanh nút 3 chấm và đảm bảo màu icon */
        .card .btn,
        .card .btn-link,
        .card .dropdown-toggle {
            background-color: transparent !important;
            border: none !important;
            color: var(--text-secondary) !important; /* Icon xám */
            box-shadow: none !important;
            padding: 0.5rem;
        }

            .card .btn-link:hover,
            .card .dropdown-toggle:hover {
                color: var(--primary-color) !important; /* Icon xanh khi hover */
                background-color: var(--bg-active) !important; /* Nền xanh rất nhạt khi hover */
                border-radius: 50%;
            }

        /* Link/Button link Đăng xuất (Đảm bảo màu nhấn) */
        .text-primary,
        .btn-link,
        a.nav-link {
            color: var(--primary-color) !important; /* Màu xanh dương nhấn (Primary color) */
        }

            .btn-link:hover,
            a.nav-link:hover {
                color: var(--primary-hover-color) !important; /* Xanh đậm hơn khi hover */
            }

        /* Định kiểu cho nút kích hoạt Dropdown (vùng email trên header) */
        .user-dropdown-toggle {
            background-color: var(--bg-hover) !important; /* Màu nền xám nhạt cho vùng email */
            color: var(--primary-color) !important; /* Màu chữ/icon nhấn (Xanh dương) */
            border-radius: 20px; /* Góc bo tròn cho vùng email */
            padding: 0.5rem 1rem !important;
            font-weight: 600;
        }

        /* ====================================================================== */

        .footer {
            display: none;
        }

        /* ---------------------------------------------------------------------- */
        /* MEDIA QUERY: Mobile (max-width: 767.98px) - OFFCANVAS FIXES */
        /* ---------------------------------------------------------------------- */
        @@media (max-width: 767.98px) {
            .app-header {
                padding: 0.5rem 0.75rem;
            }
            /* 1. Nền Offcanvas */
            .offcanvas {
                background-color: var(--bg-sidebar) !important; /* Nền sidebar */
                color: var(--text-color);
            }
            /* 2. Header Offcanvas */
            .offcanvas-header {
                background-color: var(--bg-header);
                border-bottom-color: var(--border-color);
                color: var(--text-color);
            }
            /* 3. Màu nút đóng Offcanvas (x) */
            .btn-close {
                color: var(--text-color);
                filter: none;
            }
            /* 4. Điều chỉnh Nav Links bên trong Offcanvas */
            .offcanvas-body {
                padding: 0;
            }

                .offcanvas-body .px-3 {
                    padding: 1rem !important;
                }

                .offcanvas-body .nav {
                    padding: 0 0.5rem 1rem 0.5rem;
                }

                .offcanvas-body .nav-link {
                    color: var(--text-secondary);
                    padding: 10px 18px;
                    margin: 0.25rem 0;
                    border-radius: 8px;
                }

                    .offcanvas-body .nav-link:hover {
                        background: var(--bg-hover);
                        color: var(--text-color);
                    }

                    .offcanvas-body .nav-link.active {
                        background: var(--bg-active);
                        color: var(--primary-color);
                    }
        }

        /* NEW: Move three-dots button to top-right of folder card and remove caret */
        .folder-card {
            position: relative;
            overflow: visible;
        }

            .folder-card .folder-action-btn {
                position: absolute;
                top: 8px;
                right: 8px;
                z-index: 5;
                background-color: transparent !important;
                border: none !important;
                color: var(--text-secondary) !important;
                padding: 0.25rem !important;
            }

                /* Hide bootstrap caret for this toggle only */
                .folder-card .folder-action-btn.dropdown-toggle::after {
                    display: none !important;
                }

                .folder-card .folder-action-btn:hover {
                    color: var(--primary-color) !important;
                    background-color: var(--bg-hover) !important;
                    border-radius: 50%;
                }

        /* Small nudge to shift header search slightly to the right */
        .header-search-offset {
            margin-left: 150px !important;
        }

    </style>
</head>
<body>
    @* ====================================================================== *@
    @* SCRIPT: NGĂN CHẶN NHẤP NHÁY (THEME FLICKER) - Đặt ngay sau <body> *@
    @* ====================================================================== *@
    <script>
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
            document.body.classList.add('dark-mode');
        }
    </script>

    <header class="app-header d-flex align-items-center">
        @* Nút Offcanvas cho Mobile *@
        @if (showSidebar)
        {
            <button class="btn btn-link d-md-none me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarOffcanvas" aria-controls="sidebarOffcanvas" aria-label="Mở menu">
                <span class="navbar-toggler-icon"></span>
            </button>
        }

        @* LOGO DOCNEST (SỬA ĐỔI) *@
        <a class="brand me- d-flex align-items-center gap-2" href="@logoRedirectUrl"><i class="bi bi-cloud-check-fill fs-3"></i> DocNest</a>

        <form class="d-none d-md-flex ms-2 me-auto header-search-offset" asp-controller="Documents" asp-action="Search" method="get" role="search">
            <div class="input-group" style="min-width:360px; max-width:600px;">
                <input type="search" name="query" class="form-control rounded-pill" placeholder="Tìm kiếm tài liệu..." aria-label="Tìm kiếm tài liệu">
                <button class="btn btn-outline-secondary rounded-pill ms-2" type="submit">Tìm</button>
            </div>
        </form>

        <div class="ms-auto d-flex align-items-center">
            @* NÚT CHUYỂN ĐỔI GIAO DIỆN SÁNG/TỐI *@
            <button id="theme-toggle" class="btn btn-link me-2" aria-label="Chuyển đổi giao diện">
                <i class="bi bi-moon-fill" style="font-size: 1.25rem; color: var(--text-secondary);"></i>
            </button>

            @* Partial _LoginPartial *@
            <partial name="_LoginPartial" />
        </div>
    </header>

    @* OFFCANVAS CHO MOBILE *@
    @if (showSidebar)
    {
        <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarOffcanvas" aria-labelledby="sidebarOffcanvasLabel">
            <div class="offcanvas-header app-header">
                <h5 class="offcanvas-title brand d-flex align-items-center gap-2" id="sidebarOffcanvasLabel"><i class="bi bi-cloud-check-fill fs-3"></i> DocNest Menu</h5>
                <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                @* Nội dung sidebar được lặp lại ở đây *@
                <div class="px-3 pb-3">
                    <div class="dropdown">
                        <button class="btn btn-primary w-100 rounded-pill dropdown-toggle" id="createDropdownMobile" data-bs-toggle="dropdown" aria-expanded="false">+ Tạo mới</button>
                        <ul class="dropdown-menu w-100" aria-labelledby="createDropdownMobile">
                            <li><a class="dropdown-item" asp-controller="Folders" asp-action="Create"><i class="bi bi-folder-plus me-2 text-warning"></i> Thư mục mới</a></li>
                            <li><hr class="dropdown-divider" /></li>
                            <li><a class="dropdown-item" asp-controller="Documents" asp-action="Create"><i class="bi bi-file-earmark-arrow-up me-2 text-primary"></i> Tải tệp lên</a></li>
                            <li>
                                <form asp-controller="Folders" asp-action="UploadFolder" method="post" enctype="multipart/form-data" class="m-0">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="folderId" value="@layoutFolderId" />
                                    <label class="dropdown-item mb-0" style="cursor:pointer;">
                                        <i class="bi bi-folder2-open me-2 text-warning"></i> Tải thư mục
                                        <input type="file" name="files" webkitdirectory directory multiple style="display:none" onchange="this.closest('form').submit()" />
                                    </label>
                                </form>
                            </li>
                        </ul>
                    </div>
                </div>

                <nav class="nav flex-column px-2" aria-label="Sidebar Mobile">
                    <a class="nav-link" asp-controller="Home" asp-action="Index"><i class="bi bi-house-fill me-2"></i> Trang chủ</a>
                    <a class="nav-link" asp-controller="Documents" asp-action="Index"><i class="bi bi-folder-fill me-2"></i> Tài liệu của tôi</a>
                    <a class="nav-link" asp-controller="Documents" asp-action="Shared"><i class="bi bi-share-fill me-2"></i> Chia sẻ với tôi</a>
                    <a class="nav-link" asp-controller="Documents" asp-action="Star"><i class="bi bi-star-fill me-2"></i> Gắn sao</a>
                    <a class="nav-link" asp-controller="Documents" asp-action="Trash"><i class="bi bi-trash-fill me-2"></i> Thùng rác</a>
                </nav>

                @* quota at bottom of offcanvas mobile *@
                @if (isAuthenticated)
                {
                    <div class="quota-widget mt-3 d-md-none">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <div class="small text-secondary">Bộ nhớ đã dùng</div>
                            <div class="small text-muted">@WebDocumentManagement_FileSharing.Helpers.StorageHelper.FormatSize(usedOnDisk)</div>
                        </div>
                        <div class="progress" style="height:10px;">
                            <div class="progress-bar @barClass" role="progressbar" style="width:@(pct.ToString("0.##") + "%")" aria-valuenow="@((int)Math.Round(pct))" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="d-flex justify-content-between mt-2 small">
                            <div class="text-secondary">@WebDocumentManagement_FileSharing.Helpers.StorageHelper.FormatSize(usedOnDisk)</div>
                            <div class="text-secondary">@WebDocumentManagement_FileSharing.Helpers.StorageHelper.FormatSize(quota)</div>
                        </div>
                        @if (pct >= 100)
                        {
                            <div class="mt-2 small text-danger fw-bold">Bạn đã dùng hết dung lượng.</div>
                        }
                        else if (pct >= 90)
                        {
                            <div class="mt-2 small text-warning">Bạn sắp hết dung lượng.</div>
                        }
                    </div>
                }

            </div>
        </div>
    }

    <div class="main-wrapper">
        @* Sidebar Desktop *@
        @if (showSidebar)
        {
            <aside class="sidebar d-none d-md-block">
                <div class="px-3 pb-3">
                    <div class="dropdown">
                        <button class="btn btn-primary w-100 rounded-pill dropdown-toggle" id="createDropdown" data-bs-toggle="dropdown" aria-expanded="false">+ Tạo mới</button>
                        <ul class="dropdown-menu w-100" aria-labelledby="createDropdown">
                            <li><a class="dropdown-item" asp-controller="Folders" asp-action="Create"><i class="bi bi-folder-plus me-2 text-warning"></i> Thư mục mới</a></li>
                            <li><hr class="dropdown-divider" /></li>
                            <li><a class="dropdown-item" asp-controller="Documents" asp-action="Create"><i class="bi bi-file-earmark-arrow-up me-2 text-primary"></i> Tải tệp lên</a></li>
                            <li>
                                <form asp-controller="Folders" asp-action="UploadFolder" method="post" enctype="multipart/form-data" class="m-0">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="folderId" value="@layoutFolderId" />
                                    <label class="dropdown-item mb-0" style="cursor:pointer;">
                                        <i class="bi bi-folder2-open me-2 text-warning"></i> Tải thư mục lên
                                        <input type="file" name="files" webkitdirectory directory multiple style="display:none" onchange="this.closest('form').submit()" />
                                    </label>
                                </form>
                            </li>
                        </ul>
                    </div>
                </div>

                <nav class="nav flex-column px-2" aria-label="Sidebar">
                    <a class="nav-link" asp-controller="Home" asp-action="Index"><i class="bi bi-house-fill me-2"></i> Trang chủ</a>
                    <a class="nav-link" asp-controller="Documents" asp-action="Index"><i class="bi bi-folder-fill me-2"></i> Tài liệu của tôi</a>
                    <a class="nav-link" asp-controller="Documents" asp-action="Shared"><i class="bi bi-share-fill me-2"></i> Chia sẻ với tôi</a>
                    <a class="nav-link" asp-controller="Documents" asp-action="Star"><i class="bi bi-star-fill me-2"></i> Gắn sao</a>
                    <a class="nav-link" asp-controller="Documents" asp-action="Trash"><i class="bi bi-trash-fill me-2"></i> Thùng rác</a>
                </nav>

                @* quota at bottom of desktop sidebar *@
                @if (isAuthenticated)
                {
                    <div class="quota-widget d-none d-md-block mt-auto">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <div class="small text-secondary">Bộ nhớ đã dùng</div>
                            <div class="small text-muted">@WebDocumentManagement_FileSharing.Helpers.StorageHelper.FormatSize(usedOnDisk)</div>
                        </div>
                        <div class="progress" style="height:10px;">
                            <div class="progress-bar @barClass" role="progressbar" style="width:@(pct.ToString("0.##") + "%")" aria-valuenow="@((int)Math.Round(pct))" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="d-flex justify-content-between mt-2 small">
                            <div class="text-secondary">@WebDocumentManagement_FileSharing.Helpers.StorageHelper.FormatSize(usedOnDisk)</div>
                            <div class="text-secondary">@WebDocumentManagement_FileSharing.Helpers.StorageHelper.FormatSize(quota)</div>
                        </div>
                        @if (pct >= 100)
                        {
                            <div class="mt-2 small text-danger fw-bold">Bạn đã dùng hết dung lượng.</div>
                        }
                        else if (pct >= 90)
                        {
                            <div class="mt-2 small text-warning">Bạn sắp hết dung lượng.</div>
                        }
                    </div>
                }

            </aside>
        }

        <main role="main" class="@mainContentClass">
            @RenderBody()
        </main>
    </div>

    <footer class="border-top footer text-muted">
        <div class="container">&copy;2025 - DocNest</div>
    </footer>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>

    @* ====================================================================== *@
    @* LOGIC CHUYỂN ĐỔI THEME SÁNG/TỐI (PHẦN XỬ LÝ CLICK VÀ ICON) *@
    @* ====================================================================== *@
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const toggleButton = document.getElementById('theme-toggle');
            const body = document.body;

            function applyTheme(theme) {
                const icon = toggleButton.querySelector('i');
                if (theme === 'dark') {
                    body.classList.add('dark-mode');
                    icon.className = 'bi bi-sun-fill';
                } else {
                    body.classList.remove('dark-mode');
                    icon.className = 'bi bi-moon-fill';
                }
            }

            const initialTheme = body.classList.contains('dark-mode') ? 'dark' : 'light';
            applyTheme(initialTheme);

            toggleButton.addEventListener('click', function() {
                const currentTheme = body.classList.contains('dark-mode') ? 'dark' : 'light';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

                applyTheme(newTheme);
                localStorage.setItem('theme', newTheme);
            });
        });
    </script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>