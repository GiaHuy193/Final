@using Microsoft.AspNetCore.Identity
@using WebDocumentManagement_FileSharing.Models
@using Microsoft.AspNetCore.Hosting

@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject IWebHostEnvironment Env

<ul class="navbar-nav">
    @if (SignInManager.IsSignedIn(User))
    {
        var user = await UserManager.GetUserAsync(User);

        // 1. LOGIC HIỂN THỊ TÊN
        var userName = UserManager.GetUserName(User);
        var displayName = !string.IsNullOrEmpty(userName) && userName.Contains("@")
        ? userName.Split('@')[0]
        : userName;

        var isPremium = user?.IsPremium ?? false;

        // 2. LOGIC TÌM AVATAR
        string avatarUrl = null;
        if (user != null)
        {
            var email = await UserManager.GetEmailAsync(user);
            var rawName = !string.IsNullOrEmpty(email) ? email : await UserManager.GetUserIdAsync(user);

            // Dùng System.IO.Path đầy đủ để tránh lỗi CS1061
            var invalid = System.IO.Path.GetInvalidFileNameChars();
            var cleaned = new string(rawName.Select(c => invalid.Contains(c) ? '_' : c).ToArray());
            var folderName = cleaned.Replace('@', '_').Replace(' ', '_').Trim().ToLowerInvariant();

            // Check xem có file ảnh không
            var webRoot = Env.WebRootPath;
            // Dùng System.IO.Path
            var userFolder = System.IO.Path.Combine(webRoot, "uploads", folderName);
            var allowedExts = new[] { ".png", ".jpg", ".jpeg", ".gif" };

            if (System.IO.Directory.Exists(userFolder))
            {
                foreach (var ext in allowedExts)
                {
                    // Dùng System.IO.Path và System.IO.File
                    if (System.IO.File.Exists(System.IO.Path.Combine(userFolder, "avatar" + ext)))
                    {
                        avatarUrl = $"/uploads/{folderName}/avatar{ext}?v={DateTime.Now.Ticks}";
                        break;
                    }
                }
            }
        }

        if (string.IsNullOrEmpty(avatarUrl))
        {
            avatarUrl = $"https://ui-avatars.com/api/?name={Uri.EscapeDataString(displayName)}&background=0D6EFD&color=fff&size=64&bold=true";
        }

        <li class="nav-item dropdown">
            <a id="userDropdown" class="nav-link dropdown-toggle text-dark d-flex align-items-center gap-2" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">

                @* Avatar Ảnh *@
                <img src="@avatarUrl" alt="Avatar" class="rounded-circle border border-2 border-white shadow-sm" style="width: 32px; height: 32px; object-fit: cover;">

                <span class="fw-semibold">@displayName</span>

                @if (isPremium)
                {
                    <span class="badge bg-warning text-dark border border-warning" style="font-size: 0.7rem;">Premium</span>
                }
            </a>

            <ul class="dropdown-menu dropdown-menu-end shadow border-0 rounded-3 mt-2" aria-labelledby="userDropdown">
                <li><h6 class="dropdown-header text-muted">Tài khoản</h6></li>
                <li>
                    <a class="dropdown-item py-2" asp-area="Identity" asp-page="/Account/Manage/Index">
                        <i class="bi bi-person-gear me-2 text-primary"></i> Hồ sơ cá nhân
                    </a>
                </li>

                @if (!isPremium && !User.IsInRole("Admin"))
                {
                    <li>
                        <a class="dropdown-item py-2" asp-controller="Payment" asp-action="Premium">
                            <i class="bi bi-gem me-2 text-warning"></i> Nâng cấp Premium
                        </a>
                    </li>
                }

                <li><hr class="dropdown-divider"></li>
                <li>
                    <form id="logoutForm" class="form-inline" asp-area="Identity" asp-page="/Account/Logout" asp-route-returnUrl="@Url.Action("Index", "Home", new { area = "" })">
                        <button id="logout" type="submit" class="dropdown-item py-2 text-danger">
                            <i class="bi bi-box-arrow-right me-2"></i> Đăng xuất
                        </button>
                    </form>
                </li>
            </ul>
        </li>
    }
    else
    {
        <li class="nav-item d-flex align-items-center gap-2 ms-3">
            <a class="btn btn-outline-primary rounded-pill px-4 btn-sm fw-bold" asp-area="Identity" asp-page="/Account/Login">
                Đăng nhập
            </a>
            <a class="btn btn-primary rounded-pill px-4 btn-sm fw-bold" asp-area="Identity" asp-page="/Account/Register">
                Đăng ký
            </a>
        </li>
    }
</ul>