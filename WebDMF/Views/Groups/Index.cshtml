@using WebDocumentManagement_FileSharing.Models
@{
    ViewData["Title"] = "Nhóm của tôi";
    var owned = ViewBag.OwnedGroups as List<Group> ?? new List<Group>();
    var member = ViewBag.MemberGroups as List<Group> ?? new List<Group>();
    var summary = ViewBag.GroupSummary as IDictionary<int, object> ?? new Dictionary<int, object>();
}

<style>
    /* --- WHITE THEME STYLES --- */
    :root {
        --bg-main: #f8f9fa; /* Màu nền tổng thể xám rất nhạt để làm nổi bật thẻ trắng */
        --card-bg: #ffffff;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --primary-color: #3b82f6; /* Màu nhấn đậm */
        --accent-color: #3b82f6; /* Màu xanh nhấn */
    }

    body {
        background-color: var(--bg-main);
    }

    /* Tiêu đề section */
    .section-title {
        font-size: 0.95rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-secondary);
        margin-bottom: 1rem;
        padding-left: 0.5rem;
        border-left: 4px solid var(--accent-color);
    }

    /* Card Style */
    .group-card {
        background: var(--card-bg);
        border: 1px solid rgba(0,0,0,0.04);
        border-radius: 16px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        height: 100%;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
    }

        .group-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.01);
            border-color: rgba(59, 130, 246, 0.3);
        }

    /* Icon đại diện cho nhóm */
    .group-icon-box {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        color: var(--accent-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }

    .group-card:hover .group-icon-box {
        background: linear-gradient(135deg, var(--accent-color) 0%, #2563eb 100%);
        color: white;
    }

    .group-name {
        font-weight: 700;
        color: var(--text-primary);
        text-decoration: none;
        font-size: 1.1rem;
        display: block;
        margin-bottom: 0.25rem;
    }

    .group-meta {
        font-size: 0.85rem;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .sample-docs {
        background-color: #f1f5f9;
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-top: 1rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Nút hành động */
    .btn-action-clean {
        background-color: transparent;
        color: var(--text-secondary);
        border: 1px solid #e2e8f0;
        border-radius: 50px;
        padding: 6px 16px;
        font-size: 0.85rem;
        font-weight: 600;
        transition: all 0.2s;
    }

        .btn-action-clean:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

    /* Empty State */
    .empty-state-box {
        background: white;
        border-radius: 16px;
        padding: 3rem;
        text-align: center;
        border: 2px dashed #e2e8f0;
    }
</style>

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-end mb-5">
        <div>
            <h2 class="fw-bold text-dark mb-1">Không gian làm việc</h2>
            <p class="text-muted mb-0">Quản lý các nhóm và dự án cộng tác của bạn.</p>
        </div>
        <a asp-action="Create" class="btn btn-primary rounded-pill px-4 py-2 fw-bold shadow-sm d-flex align-items-center gap-2">
            <i class="bi bi-plus-lg"></i> Tạo nhóm mới
        </a>
    </div>

    <div class="mb-5">
        <div class="section-title">Nhóm tôi quản lý (@owned.Count)</div>

        <div class="row g-4">
            @if (owned.Any())
            {
                foreach (var g in owned)
                {
                    var s = summary.ContainsKey(g.Id) ? summary[g.Id] : null;
                    <div class="col-md-6 col-lg-4">
                        <div class="group-card p-4 d-flex flex-column justify-content-between">
                            <div>
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="group-icon-box">
                                        <i class="bi bi-briefcase-fill"></i>
                                    </div>
                                    <div class="dropdown">
                                        <button class="btn btn-link text-muted p-0" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="position:relative; z-index:1050;">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end shadow border-0 rounded-3">
                                            <li><a class="dropdown-item" asp-action="Edit" asp-route-id="@g.Id"><i class="bi bi-pencil me-2"></i>Đổi tên</a></li>
                                            <li>
                                                <button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#transferModal" data-group-id="@g.Id" data-members='@Html.Raw(System.Text.Json.JsonSerializer.Serialize(g.Members.Select(m=>m.UserId)))'>
                                                    <i class="bi bi-arrow-repeat me-2"></i> Chuyển chủ nhóm
                                                </button>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-danger" asp-action="DeleteConfirm" asp-route-id="@g.Id"><i class="bi bi-trash me-2"></i>Xóa nhóm</a></li>
                                        </ul>
                                    </div>
                                </div>

                                <a asp-action="Details" asp-route-id="@g.Id" class="group-name stretched-link">@g.Name</a>
                                <div class="text-muted small mb-3">Tạo ngày: @g.CreatedDate.ToString("dd/MM/yyyy")</div>

                                @if (s != null)
                                {
                                    <div class="group-meta">
                                        <span class="meta-item" title="Số lượng tài liệu">
                                            <i class="bi bi-file-earmark-text"></i> @(((dynamic)s).DocCount)
                                        </span>
                                        <span class="meta-item" title="Số lượng thư mục">
                                            <i class="bi bi-folder"></i> @(((dynamic)s).FolderCount)
                                        </span>
                                        <span class="meta-item" title="Thành viên">
                                            <i class="bi bi-people"></i> @(g.Members?.Count ?? 0)
                                        </span>
                                    </div>

                                    @if (((IEnumerable<string>)(((dynamic)s).DocSample)).Any())
                                    {
                                        <div class="sample-docs mt-3">
                                            <i class="bi bi-clock-history me-1"></i>
                                            @string.Join(", ", ((IEnumerable<string>)(((dynamic)s).DocSample)).Take(2))
                                            @if (((IEnumerable<string>)(((dynamic)s).DocSample)).Count() > 2)
                                            {
                                                <span>...</span>
                                            }
                                        </div>
                                    }
                                }
                            </div>

                            <div class="mt-4 d-flex justify-content-between align-items-center">
                                <span class="badge bg-light text-dark border rounded-pill fw-normal px-3">Chủ nhóm</span>
                                <span class="btn-action-clean"><i class="bi bi-arrow-right"></i> Truy cập</span>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="col-12">
                    <div class="empty-state-box">
                        <div class="mb-3 text-muted opacity-50"><i class="bi bi-folder-plus" style="font-size: 3rem;"></i></div>
                        <h6 class="fw-bold">Bạn chưa tạo nhóm nào</h6>
                        <p class="text-muted small">Hãy bắt đầu bằng cách tạo một nhóm để chia sẻ tài liệu.</p>
                    </div>
                </div>
            }
        </div>
    </div>

    <div>
        <div class="section-title">Nhóm tôi tham gia (@member.Count)</div>

        <div class="row g-4">
            @if (member.Any())
            {
                foreach (var g in member)
                {
                    var s = summary.ContainsKey(g.Id) ? summary[g.Id] : null;
                    <div class="col-md-6 col-lg-4">
                        <div class="group-card p-4 d-flex flex-column justify-content-between">
                            <div>
                                <div class="group-icon-box" style="background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); color: #9333ea;">
                                    <i class="bi bi-people-fill"></i>
                                </div>

                                <a asp-action="Details" asp-route-id="@g.Id" class="group-name stretched-link">@g.Name</a>
                                <div class="text-muted small mb-3">Tham gia ngày: @(g.Members.FirstOrDefault(m => m.UserId == User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value)?.JoinedAt.ToString("dd/MM/yyyy") ?? "N/A")</div>

                                @if (s != null)
                                {
                                    <div class="group-meta">
                                        <span class="meta-item">
                                            <i class="bi bi-file-earmark-text"></i> @(((dynamic)s).DocCount)
                                        </span>
                                        <span class="meta-item">
                                            <i class="bi bi-folder"></i> @(((dynamic)s).FolderCount)
                                        </span>
                                        <span class="meta-item" title="Thành viên">
                                            <i class="bi bi-people"></i> @(g.Members?.Count ?? 0)
                                        </span>
                                    </div>
                                }
                            </div>

                            <div class="mt-4 d-flex justify-content-between align-items-center">
                                <span class="badge bg-light text-secondary border rounded-pill fw-normal px-3">Thành viên</span>
                                <span class="btn-action-clean"><i class="bi bi-arrow-right"></i> Truy cập</span>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="col-12">
                    <div class="empty-state-box">
                        <div class="mb-3 text-muted opacity-50"><i class="bi bi-inbox" style="font-size: 3rem;"></i></div>
                        <h6 class="fw-bold">Chưa tham gia nhóm nào</h6>
                        <p class="text-muted small">Khi ai đó thêm bạn vào nhóm, nó sẽ hiện ở đây.</p>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<!-- Transfer Owner Modal -->
<div class="modal fade" id="transferModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chuyển chủ nhóm</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="transferForm" method="post" asp-controller="Groups" asp-action="TransferOwnership">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <input type="hidden" name="groupId" id="transfer-groupId" />
                    <div class="mb-3">
                        <label class="form-label">Chọn thành viên</label>
                        <select name="newOwnerId" id="transfer-memberSelect" class="form-select" required>
                        </select>
                    </div>
                    <div class="form-text text-muted">Người nhận sẽ trở thành chủ nhóm. Bạn sẽ vẫn là thành viên sau khi chuyển.</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">Xác nhận chuyển</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function(){
            var transferModal = document.getElementById('transferModal');
            transferModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var groupId = button.getAttribute('data-group-id');
                var membersJson = button.getAttribute('data-members');
                var members = [];
                try { members = JSON.parse(membersJson); } catch(e) { members = []; }

                var select = document.getElementById('transfer-memberSelect');
                select.innerHTML = '';
                var lookup = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(((IDictionary<string,string>)ViewBag.GroupMemberLookup ?? new Dictionary<string,string>())));

                members.forEach(function(id){
                    var name = lookup[id] || id;
                    var opt = document.createElement('option');
                    opt.value = id;
                    opt.text = name;
                    select.appendChild(opt);
                });

                document.getElementById('transfer-groupId').value = groupId;
            });
        })();
    </script>
}